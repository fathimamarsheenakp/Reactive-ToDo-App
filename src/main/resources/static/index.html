<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>To Do App</title>
    <style>
        /* --- Basic Reset & Styling --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; height: 100vh; background: #e9ecef; color: #333; display: flex; }

        /* Sidebar (hidden by default) */
        .sidebar {
            display: none;
            width: 250px;
            background: #1f2937;
            color: #f9fafb;
            padding: 40px 25px;
            flex-direction: column;
            user-select: none;
        }
        .sidebar h2 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 45px;
            text-align: center;
            color: #10b981;
            text-transform: uppercase;
        }
        .sidebar ul { list-style: none; flex-grow: 1; }
        .sidebar li {
            padding: 15px 18px;
            margin-bottom: 18px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 17px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .sidebar li:hover { background-color: #10b981; color: #fff; transform: translateX(6px); }
        .sidebar li.active { background-color: #059669; color: #fff; transform: translateX(6px); }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 40px;
            background: white;
            overflow-y: auto;
            border-radius: 0 10px 10px 0;
            display: block; /* changed from flex */
        }


        /* Centered Login/Register Container */
        .auth-container {
            background: white;
            padding: 40px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .auth-container h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 25px;
            color: #10b981;
            text-align: center;
            text-transform: uppercase;
        }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input[type="text"], input[type="password"], textarea {
            width: 100%; padding: 10px; font-size: 16px; border: 1.5px solid #ccc; border-radius: 6px;
        }
        input:focus, textarea:focus { outline: none; border-color: #1abc9c; }

        button.addtask {
            width: 100%;
            background-color: #1abc9c;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }
        button.addtask:hover { background-color: #16a085; }

        /* Task List */
        ul { list-style: none; padding-left: 0; }
        .task-item {
            background: #f7f9fa;
            padding: 14px 20px;
            margin-bottom: 14px;
            border-left: 6px solid #1abc9c;
            border-radius: 8px;
        }
        .task-item.done { border-left-color: #6c757d; background: #f0f0f0; }
        .status-completed { color: green; font-weight: 600; margin-left: 8px; }
        .status-pending { color: red; font-weight: 600; margin-left: 8px; }

        /* Responsive */
        @media (max-width: 720px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; flex-direction: row; justify-content: space-around; padding: 15px; border-radius: 0 0 10px 10px; }
            .main-content { border-radius: 0; height: calc(100vh - 70px); padding: 20px; }
            .auth-container { width: 90%; padding: 30px 20px; }
        }
    </style>
</head>
<body>
<!-- Sidebar -->
<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <h2>To Do App</h2>
    <ul>
        <li onclick="showNewTask()">‚ûï New Task</li>
        <li onclick="showCompletedTasks()">‚úÖ Completed Tasks</li>
        <li onclick="showPendingTasks()">üïó Pending Tasks</li>
        <li onclick="showAllTasks()">üìã All Tasks</li>
        <li onclick="showBulkAddTasks()">üì¶ Add Tasks</li>
        <li onclick="logout()">üö™ Logout</li>
    </ul>
</div>

<!-- Main Content -->
<div class="main-content" id="content"></div>

<script>
    function getAuthHeaders() {
        const token = localStorage.getItem("jwtToken");
        return token ? { "Authorization": "Bearer " + token, "Content-Type": "application/json" } : { "Content-Type": "application/json" };
    }

    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem("jwtToken");
        if (token) {
            document.getElementById('sidebar').style.display = "flex";
            showAllTasks();
        } else showLogin();
    });

        // --- Auth ---

    function showRegister() {
        document.getElementById('sidebar').style.display = "none";
        document.getElementById('content').innerHTML = `
            <div class="auth-container">
                <h2>Register</h2>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="reg-username" />
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="reg-password" />
                </div>
                <button class="addtask" onclick="registerUser()">Register</button>
                <p style="margin-top:15px; text-align:center;">
                    <a href="#" onclick="showLogin()">Already have an account? Login</a>
                </p>
            </div>
        `;
    }


    function registerUser() {
        const username = document.getElementById('reg-username').value.trim();
        const password = document.getElementById('reg-password').value.trim();
        if (!username || !password) return alert("Username and password required");

        fetch("/auth/register", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({username,password})
        })
        .then(res => res.ok ? res.json() : res.text().then(t=>{throw new Error(t)}))
        .then(() => { alert("Registered! Please login."); showLogin(); })
        .catch(err => alert("Error: "+err.message));
    }

    function showLogin() {
        document.getElementById('sidebar').style.display = "none";
        document.getElementById('content').innerHTML = `
            <div class="auth-container">
                <h2>Login</h2>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="login-username" />
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" />
                </div>
                <button class="addtask" onclick="loginUser()">Login</button>
                <p style="margin-top:15px; text-align:center;">
                    <a href="#" onclick="showRegister()">Don't have an account? Register</a>
                </p>
            </div>
        `;
    }

    function loginUser() {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value.trim();
        if (!username || !password) return alert("Username and password required");

        fetch("/auth/login", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({username,password})
        })
        .then(async res => {
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "Login failed");
            return data;
        })
        .then(data => {
            localStorage.setItem("jwtToken", data.token);
            document.getElementById('sidebar').style.display = "flex";
            showAllTasks();
        })
        .catch(err => alert("Error: " + err.message));
    }

         function logout() {
            localStorage.removeItem("jwtToken");
            document.getElementById('sidebar').style.display = "none";
            showLogin();
        }

        // --- Tasks ---
        function showAllTasks() {
            document.getElementById('content').innerHTML = `<div style="width:100%"><h2>All Tasks</h2><div style="margin-bottom:15px;">
                <input type="text" id="searchInput" placeholder="Search..." />
                <button class="addtask" onclick="searchTasks()">Search</button>
            </div><div id="taskList"></div></div>`;
            fetch("/todo", { headers: getAuthHeaders() })
            .then(res => res.ok ? res.json() : res.text().then(t=>{throw new Error(t)}))
            .then(tasks => renderTasks(tasks))
            .catch(err => alert("Error: "+err.message));
        }

        function addTask() {
            const name = document.getElementById('name').value.trim();
            const description = document.getElementById('description').value.trim();
            if(!name) return alert("Task name required");

            fetch("/todo/add", {
                method: "POST",
                headers: getAuthHeaders(),
                body: JSON.stringify({name,description})
            })
            .then(res=>res.ok?res.json():res.text().then(t=>{throw new Error(t)}))
            .then(()=>{ alert("Task added"); showAllTasks(); })
            .catch(err=>alert("Error: "+err.message));
        }

        function showAllTasks() {
            document.getElementById('content').innerHTML = `
                <h2>All Tasks</h2>
                <div style="margin-bottom:15px;">
                    <input type="text" id="searchInput" placeholder="Search..." />
                    <button class="addtask" onclick="searchTasks()">Search</button>
                </div>
                <div id="taskList"></div>
            `;
            fetch("/todo", { headers: getAuthHeaders() })
            .then(res=>res.ok?res.json():res.text().then(t=>{throw new Error(t)}))
            .then(tasks=>renderTasks(tasks))
            .catch(err=>alert("Error: "+err.message));
        }

        function searchTasks() {
            const query = document.getElementById('searchInput').value.trim();
            fetch(`/todo/search?name=${encodeURIComponent(query)}`, { headers: getAuthHeaders() })
            .then(res=>res.ok?res.json():res.text().then(t=>{throw new Error(t)}))
            .then(tasks=>renderTasks(tasks))
            .catch(err=>alert("Error: "+err.message));
        }

        function renderTasks(tasks) {
            const list = document.getElementById('taskList');
            if(!tasks.length){ list.innerHTML='<p>No tasks found.</p>'; return; }
            let html = '<ul>';
            tasks.forEach(t=>{
                html+=`<li class="task-item ${t.completed?'done':''}">
                    <h3>${t.name} <span class="${t.completed?'status-completed':'status-pending'}">(${t.completed?'Completed':'Pending'})</span></h3>
                    <p>${t.description}</p>
                    ${!t.completed?`<button onclick="editTask('${t.id}','${encodeURIComponent(t.name)}','${encodeURIComponent(t.description)}')">‚úèÔ∏è Edit</button>
                    <button onclick="markDone('${t.id}')">‚úÖ Complete</button>`:``}
                    <button onclick="deleteTask('${t.id}')">üóëÔ∏è Delete</button>
                </li>`;
            });
            html+='</ul>';
            list.innerHTML = html;
        }

        function editTask(id,name,desc){
            name=decodeURIComponent(name); desc=decodeURIComponent(desc);
            document.getElementById('content').innerHTML=`
                <h2>Edit Task</h2>
                <div class="form-group">
                    <label>Task Name</label>
                    <input type="text" id="edit-name" value="${name}" />
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="edit-desc">${desc}</textarea>
                </div>
                <button class="addtask" onclick="saveTask('${id}')">üíæ Save</button>
                <button class="addtask" onclick="showAllTasks()">‚ùå Cancel</button>
            `;
        }

         function showNewTask() {
            document.getElementById('content').innerHTML = `
                <h2>Create New Task</h2>
                <div class="form-group">
                    <label>Task Name</label>
                    <input type="text" id="name" />
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" rows="4"></textarea>
                </div>
                <button class="addtask" onclick="addTask()">Add Task</button>
            `;
        }


        function saveTask(id){
            const name=document.getElementById('edit-name').value.trim();
            const description=document.getElementById('edit-desc').value.trim();
            if(!name) return alert("Task name required");

            fetch(`/todo/edit/${id}`, {
                method:"PUT",
                headers:getAuthHeaders(),
                body: JSON.stringify({name,description})
            })
            .then(res=>res.ok?res.json():res.text().then(t=>{throw new Error(t)}))
            .then(()=>{ alert("Task updated"); showAllTasks(); })
            .catch(err=>alert("Error: "+err.message));
        }

        function markDone(id){
            fetch(`/todo/${id}/complete`, { method:"PATCH", headers:getAuthHeaders() })
            .then(res=>res.ok?res.json():res.text().then(t=>{throw new Error(t)}))
            .then(()=>showAllTasks())
            .catch(err=>alert("Error: "+err.message));
        }

        function deleteTask(id){
            if(!confirm("Delete this task?")) return;
            fetch(`/todo/delete/${id}`, { method:"DELETE", headers:getAuthHeaders() })
            .then(res=>res.ok?showAllTasks():res.text().then(t=>{throw new Error(t)}))
            .catch(err=>alert("Error: "+err.message));
        }

        function showCompletedTasks(){
            fetch('/todo/completed',{headers:getAuthHeaders()})
            .then(res=>res.ok?res.json():res.text().then(t=>{throw new Error(t)}))
            .then(tasks=>renderSimpleTasks('Completed Tasks',tasks))
            .catch(err=>alert("Error: "+err.message));
        }

        function showPendingTasks(){
            fetch('/todo/pending',{headers:getAuthHeaders()})
            .then(res=>res.ok?res.json():res.text().then(t=>{throw new Error(t)}))
            .then(tasks=>renderSimpleTasks('Pending Tasks',tasks,true))
            .catch(err=>alert("Error: "+err.message));
        }

        function renderSimpleTasks(title,tasks,showDoneButton=false){
            const content=document.getElementById('content');
            content.innerHTML=`<h2>${title}</h2>`;
            if(!tasks.length){ content.innerHTML+='<p>No tasks found.</p>'; return; }
            const ul=document.createElement('ul');
            tasks.forEach(t=>{
                const li=document.createElement('li');
                li.className='task-item';
                li.innerHTML=`<strong>${t.name}</strong>: ${t.description}
                    ${(!t.completed || showDoneButton)?`<button onclick="markDone('${t.id}')">‚úÖ Complete</button>`:''}`;
                ul.appendChild(li);
            });
            content.appendChild(ul);
        }

        function showBulkAddTasks(){
            document.getElementById('content').innerHTML=`
                <h2>Bulk Add Tasks</h2>
                <div id="bulkContainer">
                    <div class="form-group bulk-task">
                        <label>Task 1 Name</label>
                        <input type="text" class="bulk-name" />
                        <label>Description</label>
                        <textarea class="bulk-desc"></textarea>
                    </div>
                </div>
                <button onclick="addBulkInput()">‚ûï Add More</button>
                <button class="addtask" onclick="submitBulk()">Submit All</button>
            `;
        }

        function addBulkInput(){
            const count=document.querySelectorAll('.bulk-task').length+1;
            const container=document.getElementById('bulkContainer');
            const div=document.createElement('div');
            div.className='form-group bulk-task';
            div.innerHTML=`<label>Task ${count} Name</label><input type="text" class="bulk-name" /><label>Description</label><textarea class="bulk-desc"></textarea>`;
            container.appendChild(div);
        }

        function submitBulk(){
            const names=document.querySelectorAll('.bulk-name');
            const descs=document.querySelectorAll('.bulk-desc');
            const tasks=[];
            for(let i=0;i<names.length;i++){
                const name=names[i].value.trim();
                const desc=descs[i].value.trim();
                if(name) tasks.push({name,description:desc});
            }
            if(!tasks.length) return alert("Enter at least one task");
            fetch('/todo/add/bulk',{
                method:"POST",
                headers:getAuthHeaders(),
                body:JSON.stringify(tasks)
            })
            .then(res=>res.ok?res.json():res.text().then(t=>{throw new Error(t)}))
            .then(()=>{ alert("Tasks added!"); showAllTasks(); })
            .catch(err=>alert("Error: "+err.message));
        }
</script>
</body>
</html>
